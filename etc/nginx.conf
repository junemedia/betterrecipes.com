################################################################################
# betterrecipes
server {
    server_name                 betterrecipes
                                mixingbowl.com
                                www.mixingbowl.com
                                www.betterrecipes.com
                                appetizer.betterrecipes.com
                                beef.betterrecipes.com
                                bread.betterrecipes.com
                                breakfast.betterrecipes.com
                                cake.betterrecipes.com
                                chicken.betterrecipes.com
                                christmas.betterrecipes.com
                                cookie.betterrecipes.com
                                crockpot.betterrecipes.com
                                dessert.betterrecipes.com
                                diabetic.betterrecipes.com
                                drink.betterrecipes.com
                                easter.betterrecipes.com
                                easy.betterrecipes.com
                                fxb.betterrecipes.com
                                grilling.betterrecipes.com
                                groups.betterrecipes.com
                                halloween.betterrecipes.com
                                healthy.betterrecipes.com
                                italian.betterrecipes.com
                                lowcarb.betterrecipes.com
                                lowfat.betterrecipes.com
                                mexican.betterrecipes.com
                                mixingbowl.betterrecipes.com
                                pork.betterrecipes.com
                                recipes.betterrecipes.com
                                restaurant.betterrecipes.com
                                salad.betterrecipes.com
                                seafood.betterrecipes.com
                                soup.betterrecipes.com
                                thanksgiving.betterrecipes.com
                                vegetarian.betterrecipes.com
                                ~.*betterrecipes\.[^\.]+?\.resolute\.com;
    root                        /srv/sites/betterrecipes/web;
    # /index.php fix
    rewrite ^/index.php/(.*) /$1 permanent;
    rewrite ^/index.php$ / permanent;

    # set the correct domain for the "uid" cookie
    userid_domain               .betterrecipes.com;

    if ($betterrecipes_redirects != FALSE) {
        rewrite ^               $betterrecipes_redirects permanent;
    }

    # betterrecipes.resolute.com 301 redirect
    if ($host ~ ^(.*?betterrecipes)\.resolute\.com$) {
        set $br_host            $1;
        rewrite ^               http://$br_host.com$request_uri permanent;
    }

    # Device detection
    set $device                 $dev_ffs_map;

    # Caching
    set $cache                  $lis_cache_map;
    if ($uri ~ ^/(_|admin|sign|log|ckfinder|auth|recipes/new)) {
        set $cache              0;
    }

    fastcgi_cache               MBR;
    # Include Query String for certain URL exemptions
    # fastcgi_cache_key           $device$request_method$http_host$br_cache_uri_map;
    fastcgi_cache_key           $request_method$http_host$br_cache_uri_map; # removed $device since the mobile site is disabled

    # remove any trailing slash
    if ($uri !~ ^/(admin|blogs)) {
        rewrite ^(.+)/$         $1 permanent;
    }

    # sitemap redirects
    rewrite /sitemap.xml        /sitemaps/sitemap-$host.xml;

    # Resolute Digital Geo Services
    location /geo {
        proxy_pass              http://mfs/geo;
        proxy_cache             off;
        proxy_set_header        Host                resolute.com;
        proxy_set_header        X-Real-IP           $remote_addr;
        proxy_set_header        X-Forwarded-For     $proxy_add_x_forwarded_for;
    }

    # Daily Dish Blog Reverse Proxy
    location ~ ^/blogs/daily-dish {
        # do not log these twice
        access_log              off;
        proxy_pass              http://mfs;
        gzip_vary               off;
        proxy_set_header        Host blogs.mydevstaging.com;
        proxy_set_header        X-Forwarded-Host    $http_host;
        proxy_set_header        X-Forwarded-For     $proxy_add_x_forwarded_for;
        proxy_cache_bypass      1; # Don't cache here, it is cached
        proxy_no_cache          1; # in the blogs' server { }
    }

    # Baynote XML Document Downloads
    location ~ /uploads/ftp/baynote_.*\.xml {
        auth_basic              "Baynote";
        auth_basic_user_file    /srv/sites/betterrecipes/config/htpasswd.txt;
    }

    # Recipe Images (with default)
    location ~ /uploads/photo/(.*?)/.* {
        expires                 30d;
        try_files               $uri /img/default-recipe-img-$1.jpg;
    }

    # CKFinder
    location ~ ^/ckfinder/core/connector/php/connector.php {
        set $cache              0;
        set $script_name        /ckfinder/core/connector/php/connector.php;
        try_files               /dev/null @php;
    }

    include                     universal.conf;
    include                     symfony.conf;
    include                     admin.conf;
}

server {
    server_name                 betterrecipes-redirect
                                betterrecipes.com;
    rewrite ^                   http://www.betterrecipes.com$request_uri permanent;
}

server {
    server_name                 betterrecipes-redirect-2
                                kmb.mixingbowl.com;
    root                        /srv/sites/betterrecipes;
    rewrite ^                   $kelloggs_redirects permanent;
}

map $uri $br_cache_uri_exempt {
    default                     0;
    ~^/search                   1; # /search? must cache with query string (possibly make this global)
}

map $is_ajax$br_cache_uri_exempt $br_cache_uri_map {
    default                     $request_uri;
    00                          $uri;
}

map $uri                        $betterrecipes_redirects {
    default                                             FALSE;
    /groups                                             /;
    /cooks                                              /;
    /mixing-bowl                                        /;
    /polls                                              /;
    /discussions                                        /;
    /photos                                             /;
    /rewards                                            /;
    /videos                                             /;
    /journals                                           /;
    /wintoday                                           http://win.betterrecipes.com/;
    /win                                                http://win.betterrecipes.com/;
    /kelloggs                                           http://easy.betterrecipes.com/groups/comfortfoodbliss;
    /bloggiveaway                                       /blogs/daily-dish/2012/06/04/homemade-popsicle-prize-package/;
    /blogs/daily-dish                                   /blogs/daily-dish/;
    /favorites/index.html                               http://www.betterrecipes.com/recipes;
    /favorites.html                                     http://www.betterrecipes.com/recipes;
    /contest                                            http://www.betterrecipes.com/contests;
    /contest/                                           http://www.betterrecipes.com/contests;
    /christmas/cookie-recipes.html                      http://christmas.betterrecipes.com/cookie-recipes.html;
    /christmas/christmas-recipes.html                   http://christmas.betterrecipes.com/christmas-recipes.html;
    /christmas/dinner-recipes.html                      http://christmas.betterrecipes.com/dinner-recipes.html;
    /dishitout                                          http://pork.betterrecipes.com/groups/start-with-pork/discussions/Start_with_Pork_-_You_Could_Win_%24500!/29045391;
    /drink/holiday-jello-shots.html                     http://drink.betterrecipes.com/holiday-jello-shots.html;
    /drink/mixed-drink-recipes.html                     http://drink.betterrecipes.com/mixed-drink-recipes.html;
    /halloween/gross-recipes.html                       http://halloween.betterrecipes.com/gross-recipes.html;
    /halloween/how-to-cook-pumpkin-seeds.html           http://halloween.betterrecipes.com/how-to-cook-pumpkin-seeds.html;
    /halloween/how-to-make-treats.html                  http://halloween.betterrecipes.com/how-to-make-treats.html;
    /halloween/easy-recipes.html                        http://halloween.betterrecipes.com/easy-halloween-recipes.html;
    /thanksgiving/how-to-cook-a-turkey.html             http://thanksgiving.betterrecipes.com/how-to-cook-a-turkey.html;
    /thanksgiving/why-do-we-eat-turkey.html             http://thanksgiving.betterrecipes.com/why-do-we-eat-turkey.html;
    /thanksgiving/traditional-recipes.html              http://thanksgiving.betterrecipes.com/traditional-recipes.html;
    /thanksgiving/dessert-recipes.html                  http://thanksgiving.betterrecipes.com/dessert-recipes.html;
    /thanksgiving/dressing-recipes.html                 http://thanksgiving.betterrecipes.com/dressing-recipes.html;
    /group/usergroup/view.castle?g=1905753              http://groups.betterrecipes.com/groups/easycerealsnacks;
    /group/usergroup/view.castle?g=1905795              http://breakfast.betterrecipes.com/groups/quickstartbreakfasts;
    /group/usergroup/view.castle?g=1905725              http://appetizer.betterrecipes.com/groups/creativecrackerrecipes;
    /group/usergroup/view.castle?g=1905824              http://groups.betterrecipes.com/groups/simpletakeoutmakeovers;
    /group/usergroup/view.castle?g=1905813              http://dessert.betterrecipes.com/groups/simpledessertshortcuts;
    /group/usergroup/view.castle?g=1905732              http://easy.betterrecipes.com/groups/dinnerinaflash;
    /group/usergroup/view.castle?g=1905784              http://easy.betterrecipes.com/groups/quickeats;
    /group/usergroup/view.castle?g=1905762              http://groups.betterrecipes.com/groups/entertaininginspiration;
    /group/usergroup/view.castle?g=1905781              http://easy.betterrecipes.com/groups/kidfavorites;
    /group/usergroup/view.castle?g=1905710              http://easy.betterrecipes.com/groups/comfortfoodbliss;
    /gallery/lemon-recipes/                             http://lowfat.betterrecipes.com/slideshows/easy-lemon-recipes;
    /gallery/easy-thanksgiving-recipes/                 http://thanksgiving.betterrecipes.com/slideshows/easy-thanksgiving-recipes;
    /gallery/easy-vegetable-recipes/                    http://vegetarian.betterrecipes.com/slideshows/easy-vegetarian-recipes;
    /lowcarbbeef,porkandlamb.html                       http://lowcarb.betterrecipes.com/lowcarbbeefporkandlamb.html;
    /chowders,bisques,andgumbos.html                    http://soup.betterrecipes.com/chowdersbisquesandgumbos.html;
    /gallery/easy-pasta-recipes/                        http://italian.betterrecipes.com/slideshows/easy-pasta-recipes;
    /betterrecipes/file.jsp?item=/selfservice/home      /advertise/;
    /betterrecipes/file.jsp?item=/selfservice/specs     /advertise/specs;
    /betterrecipes/file.jsp?item=/selfservice/faq       /advertise/faq;
    /betterrecipes/file.jsp?item=/selfservice/contact   /advertise/contact;
    /betterrecipes/files/selfservice/BR_ProposalBuilder_Guide.pdf   /advertise/BR_ProposalBuilder_Guide.pdf;
}

map $request_uri                $kelloggs_redirects {
    default                             http://italian.betterrecipes.com/slideshows/easy-dinner-recipes;
    /marvelous-muffins/                 http://breakfast.betterrecipes.resolute.com/slideshows/easy-muffin-recipes;
    /babysitter-dinners/                http://italian.betterrecipes.resolute.com/slideshows/easy-dinner-recipes;
    /salad-ideas/                       http://salad.betterrecipes.resolute.com/slideshows/salad-recipes;
    /one-dish-meals/                    http://christmas.betterrecipes.resolute.com/slideshows/casseroles;
    /burgers-and-sandwiches/            http://healthy.betterrecipes.resolute.com/slideshows/burgers-wraps-sandwiches;
    /holiday-party-snacks/              http://halloween.betterrecipes.resolute.com/slideshows/easy-party-recipes;
    /holiday-pies/                      http://thanksgiving.betterrecipes.resolute.com/slideshows/easy-holiday-pies;
    /cookies-and-cakes/                 http://cookie.betterrecipes.resolute.com/slideshows/easy-dessert-recipes;
    /rice-krispies/                     http://dessert.betterrecipes.resolute.com/slideshows/rice-krispie-treats;
}
