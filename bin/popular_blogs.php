<?

$blog_tags_array = array
(
	'appetizer' => 		array('Appetizer Recipes', 'Biscuits and Roll Recipes', 'Cold Appetizer Recipes', 'Dips and Spreads', 'Fondue', 'Fruit Appetizers', 'Hot Appetizers', 'Vegetable Appetizers'),
	'beef' => 			array('Beef Casserole Recipes', 'Beef Main Dish Recipes', 'Beef Recipes', 'Beef Sandwich Recipes', 'Beef Sauces & Gravy Recipes', 'Beef Soups & Stew Recipes', 'Beef Stir-fry Recipes', 'Hamburger Recipes'),
	'bread' => 			array('Banana Bread', 'Biscuits and Roll Recipes', 'bread', 'Bread Machine Recipes', 'Bread Recipes', 'Cornbread Recipes', 'Muffins and Scones', 'Quick Breads', 'Sweet Bread Recipes', 'White Bread', 'Whole Wheat Bread', 'Yeast Bread'),
	'breakfast' => 		array('Biscuits and Roll Recipes', 'breakfast', 'Breakfast Casseroles Recipes', 'Breakfast Pizza Recipes', 'Breakfast Recipes', 'Eggs', 'French Toast Recipes', 'Pancakes and Waffles'),
	'cake' => 			array('Angel Food Cake Recipes', 'Birthday Cake Recipes', 'Cake Recipes', 'Chocolate Cake Recipes', 'Christmas Cake Recipes', 'Christmas Dessert Recipes', 'Creamed Cake Recipes', 'Cupcake Recipes', 'Sponge and Chiffon Cake Recipes', 'White Cake Recipes', 'Yellow Cakes'),
	'chicken' => 		array('Baked Chicken Recipes', 'chicken', 'Chicken Casserole Recipes', 'Chicken Glazes & Rubs', 'Chicken in 30 Minutes', 'Chicken Recipes', 'Chicken Salad Recipes', 'Chicken Sandwiches', 'Chicken Soup Recipes', 'Chicken Stir-Fry Recipes', 'Make-Ahead Chicken'),
	'christmas' =>		array('Angel Food Cake Recipes', 'Christmas Cake Recipes', 'Christmas Candy Recipes', 'Christmas Cookie Recipes', 'Christmas Dessert Recipes', 'Christmas Dinner Recipes', 'Christmas Fudge Recipes', 'Christmas Recipes'),
	'cookie' =>			array('50 State Cookie Recipes', 'Bar Cookie Recipes', 'Chocolate Chip Cookies', 'Christmas Cookie Recipes', 'Christmas Dessert Recipes', 'Cookie Recipes', 'Cookies for Grown-Ups', 'Cookies for Kids', 'Cutout Cookie Recipes', 'Drop Cookie Recipes', 'Make-Ahead Cookie Recipes'),
	'copycat' =>		array('restaurant recipe', 'restaurant recipes'),
	'crockpot' =>		array('Crock-Pot Chicken Recipes', 'Crock-Pot Dessert & Snack Recipes', 'Crock-Pot Dinner Recipes', 'Crock-Pot Meat Recipes', 'Crock-Pot Recipes', 'Crock-Pot Soup & Stew Recipes', 'Crock-Pot Vegetarian Recipes', 'Vegetarian Crock-Pot Recipes'),
	'dessert' =>		array('50 State Cookie Recipes', 'Angel Food Cake Recipes', 'Brownies', 'Cake Recipes', 'Candy Recipes', 'Cheesecakes', 'Christmas Cake Recipes', 'Christmas Candy Recipes', 'Christmas Cookie Recipes', 'Christmas Dessert Recipes', 'Christmas Fudge Recipes', 'Crock-Pot Dessert & Snack Recipes', 'Cupcake Recipes', 'Custard & Pudding', 'Cutout Cookie Recipes', 'Dessert Pizza', 'Dessert Recipes', 'Dessert Salads', 'Frozen Dessert Recipes', 'Fruit Dessert Recipes', 'Ice Cream & Sorbets', 'Ice Cream Drink Recipes', 'No-Bake Desserts', 'Pastries', 'Pies & Pastries'),
	'diabteic' =>		array('Diabetic Breakfast Recipes', 'Diabetic Dessert Recipes', 'Diabetic Dinner Recipes', 'Diabetic Recipes', 'Diabetic Recipes for Kids', 'Diabetic Soup Recipes', 'Diabetic-Friendly Thanksgiving Recipes', 'Main Dishes for Diabetics'),
	'drink' =>			array('beer', 'cocktails', 'Coffee Recipes', 'Drink Recipes', 'Martini Recipes', 'Mixed Drink Recipes', 'Nonalcoholic Drink Recipes', 'Smoothie Recipes', 'Spooky Drink Recipes', 'Tea Recipes'),
	'easter' =>			array('Easter Breads', 'Easter Desserts', 'Easter Kidsâ€™ Recipes', 'Easter Ham Recipes', 'Easter Main Dishes', 'Easter Pork Recipes', 'Easter Recipes', 'Easter Side Dishes'),
	'easy' =>			array('Easy Beef Recipes', 'Easy Bread Recipes', 'Easy Breakfast Recipes', 'Easy Cake Recipes', 'Easy Chicken Recipes', 'Easy Dessert Recipes', 'Easy Pasta Recipes', 'Easy Pizza Recipes', 'Easy Recipes', 'Easy Salad Recipes', 'Easy Sandwich Recipes', 'Easy Seafood Recipes', 'Easy Snack Recipes', 'Easy Soup Recipes', 'Easy Vegetable Recipes', 'Sandwiches', 'pizza'),
	'grilling' =>		array('Grilled Beef Recipes', 'Grilled Burgers & Brats', 'Grilled Chicken & Turkey Recipes', 'Grilled Chicken Recipes', 'Grilled Dessert Recipes', 'Grilled Fish Recipes', 'Grilled Kabob Recipes', 'Grilled Pork Recipes', 'Grilled Recipes', 'Grilled Vegetable Recipes'),
	'halloween' =>		array('Halloween Party Recipes', 'Halloween Recipes', 'Halloween Snacks', 'Halloween Treat Recipes'),
	'healthy' =>		array('Healthy Bread Recipes', 'Healthy Breakfast Recipes', 'Healthy Dessert Recipes', 'Healthy Fish Recipes', 'Healthy Meat Recipes', 'Healthy Poultry Recipes', 'Healthy Recipes', 'Healthy Side Dishes', 'Healthy Snack Recipes', 'Healthy Vegetarian Recipes', 'tomato'),
	'italian' =>		array('Italian Appetizers', 'Italian Bread Recipes', 'Italian Cookie Recipes', 'Italian Dessert Recipes', 'Italian Dinner Recipes', 'Italian Lasagna Recipes', 'Italian Pasta Recipes', 'Italian Recipes', 'pizza', 'risotto'),
	'lowcarb' =>		array('Low-Carb Beef Pork and Lamb', 'Low-Carb Breakfasts', 'Low-Carb Desserts', 'Low-Carb Dinner Recipes', 'Low-Carb Poultry', 'Low-Carb Recipes', 'Low-Carb Snacks', 'Low-Carb Vegetables and Sides'),
	'lowfat' =>			array('Low-Fat Breakfast Recipes', 'Low-Fat Cakes', 'Low-Fat Cookies', 'Low-Fat Desserts', 'Low-Fat Dinner Recipes', 'Low-Fat Pies and Tarts', 'Low-Fat Recipes', 'Low-Fat Recipes for Kids', 'Low-Fat Side Dishes'),
	'mexican' =>		array('Mexican Appetizer & Drink Recipes', 'Mexican Chicken Recipes', 'Mexican Dessert Recipes', 'Mexican Dishes', 'Mexican Recipes', 'Mexican Rice Beans & Eggs', 'Mexican Salsas'),
	'pork' =>			array('bacon', 'Ham', 'pork', 'Pork Chops', 'Pork Recipes', 'Pork Roast Recipes', 'Pork Stir-fry Recipes', 'Ribs'),
	'salad' =>			array('Bean Salads', 'Chicken Salad Recipes', 'Dessert Salads+Y4', 'Dressings', 'Fruit Salads', 'Green Salads', 'Layered Salads', 'Main Dish Salad Recipes', 'Pasta Salads', 'Salad Recipes', 'Vegetable Salads'),
	'seafood' =>		array('Fish', 'Salmon', 'Seafood Recipes', 'Seafood Salads', 'Seafood Sauces', 'Seafood Stir-fry Recipes', 'Shellfish', 'Shrimp'),
	'soup' =>			array('Bean Soup Recipes', 'Beef Soups & Stew Recipes', 'Chicken Soup Recipes', 'Chili Recipes', 'Chowders Bisques and Gumbos', 'Creamed Soup Recipes', 'Crock-Pot Soup & Stew Recipes', 'Noodle Soup Recipes', 'soup', 'Soup Recipes', 'Stew Recipes', 'Vegetable Soup Recipes'),
	'thanksgiving' =>	array('Crock-Pot Dinner Recipes', 'Healthy Thanksgiving Recipes', 'Low-Carb Thanksgiving Recipes', 'Thanksgiving Dessert Recipes', 'Thanksgiving Dinner Recipes', 'Thanksgiving Leftovers', 'Thanksgiving Recipes', 'Thanksgiving Side Dish Recipes'),
	'vegetarian' =>		array('Crock-Pot Vegetarian Recipes', 'Vegetarian Dinner Recipes', 'Vegetarian Recipes', 'Vegetarian Recipes for Two', 'Vegetarian Sandwich Recipes', 'Vegetarian Soup Recipes', 'Vegetarian Stir-Fry Recipes')
);

$db = new MySQLi(
      ini_get("mysqli.default_host")
    , ini_get("mysqli.default_user")
    , ini_get("mysqli.default_pw")
    , 'blogs'
    , ini_get("mysqli.default_port")
);

if ($db->connect_error) {
    debug("Could not connect to MySQL: ".$db->connect_error);
}

foreach( $blog_tags_array as $subdomain => $tag_array )
{
	$where = "WHERE post_type = 'post' AND (";
	$term_name_count = count( $tag_array );
	$count = 0;
	$params = array();
	$param_types = "";
	foreach( $tag_array as $term_name )
	{
		if( $count == $term_name_count || $count == 0 )
		{
			$where .= " wp_27_terms.name = ?";
			$params[] = $term_name;
			$param_types .= "s";
		}else
		{
			$where .= " OR wp_27_terms.name = ?";
			$params[] = $term_name;
			$param_types .= "s";
		}
		$count++;
	}
	$where .= ") ORDER BY wp_27_posts.post_date DESC LIMIT 6;";
	$query = "SELECT DISTINCT post_title, post_date, post_content, guid
				FROM wp_27_posts
				JOIN wp_27_term_relationships ON wp_27_term_relationships.object_id = wp_27_posts.id
				JOIN wp_27_term_taxonomy ON wp_27_term_relationships.term_taxonomy_id = wp_27_term_taxonomy.term_taxonomy_id
				JOIN wp_27_terms ON wp_27_terms.term_id = wp_27_term_taxonomy.term_id " . $where;

	$params = array_merge( (array)$param_types, $params );
	$params = getRefArray( $params );

	if(!($stmt = $db->prepare( $query )))
	{
		echo "Prepare failed: (" . $db->errno . ") " . $db->error;
		echo $query;
	}else
	{
		$ref = new ReflectionClass('mysqli_stmt');
		$method = $ref->getMethod("bind_param");
		$method->invokeArgs($stmt,$params);

		if (!$stmt->execute())
		{
			echo "Execute failed: (" . $stmt->errno . ") " . $stmt->error;
			echo $stmt;
		}
		$results = $stmt->get_result();

		$memcache = new Memcache();
		$memcache->connect('mmc', 11211);
		$results_array = array();

		while( $row = $results->fetch_assoc() )
		{
			$blog_array['title'] = $row['post_title'];
			$blog_array['date'] = $row['post_date'];
			preg_match( '/<img[^>]+src="([^"]+)"/', $row['post_content'], $pictures_array );
			if( !empty($pictures_array) )
			{
				$blog_array['picture'] = $pictures_array[1];
			}
			$blog_array['guid'] = $row['guid'];
			$results_array[] = $blog_array;
		}
		
		$memcache->set('br_pop_blogs_' . md5($subdomain), $results_array, 0, 86400); //Queue lasts for 1 day max
		$memcache->close();

		$stmt->close();
	}
}

function getRefArray($a)
{ 
	if (strnatcmp(phpversion(),'5.3')>=0) { 
	    $ret = array(); 
	    foreach($a as $key => $val) { 
	        $ret[$key] = &$a[$key]; 
	    } 
	    return $ret; 
	} 
	return $a; 
}
?>